<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <title>Signal Quality - USA Sector Rotation</title>
    <!-- Version: 2026.02.01.v1 - Aligned with KRX layout -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #0f172a;
            color: #f8fafc;
            min-height: 100vh;
        }

        .header {
            background: #1e293b;
            border-bottom: 1px solid #334155;
            padding: 1.5rem 2rem;
        }

        .header h1 {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 0.5rem;
        }

        .header p {
            color: #94a3b8;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
        }

        .nav-links a {
            color: #94a3b8;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
        }

        .nav-links a:hover, .nav-links a.active {
            background: #334155;
            color: #f8fafc;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }

        .summary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .summary-card {
            background: #1e293b;
            border-radius: 0.75rem;
            padding: 1.5rem;
            text-align: center;
        }

        .summary-card.positive {
            border-left: 4px solid #10b981;
        }

        .summary-card.warning {
            border-left: 4px solid #f59e0b;
        }

        .summary-label {
            color: #94a3b8;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .summary-value {
            font-size: 2.5rem;
            font-weight: bold;
        }

        .summary-value.positive {
            color: #10b981;
        }

        .summary-subtext {
            color: #64748b;
            font-size: 0.75rem;
            margin-top: 0.25rem;
        }

        .charts-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        @media (max-width: 900px) {
            .charts-row {
                grid-template-columns: 1fr;
            }
        }

        .section {
            background: #1e293b;
            border-radius: 0.75rem;
            padding: 1.5rem;
            margin-bottom: 2rem;
        }

        .section h2 {
            font-size: 1.25rem;
            margin-bottom: 1rem;
        }

        .chart-wrapper {
            min-height: 300px;
            position: relative;
        }

        .chart-wrapper.funnel-wrapper {
            min-height: auto;
            height: auto;
        }

        /* Gauge Chart */
        .gauge-container {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
        }

        .gauge {
            width: 200px;
            height: 100px;
            position: relative;
            overflow: hidden;
        }

        .gauge-background {
            width: 200px;
            height: 100px;
            border-radius: 100px 100px 0 0;
            background: linear-gradient(to right, #ef4444 0%, #f59e0b 50%, #10b981 100%);
        }

        .gauge-center {
            position: absolute;
            width: 140px;
            height: 70px;
            bottom: 0;
            left: 30px;
            background: #1e293b;
            border-radius: 70px 70px 0 0;
        }

        .gauge-needle {
            position: absolute;
            width: 4px;
            height: 80px;
            background: #f8fafc;
            bottom: 0;
            left: 98px;
            transform-origin: bottom center;
            transition: transform 1s ease-out;
        }

        .gauge-value {
            font-size: 2.5rem;
            font-weight: bold;
            color: #10b981;
            margin-top: 1rem;
        }

        .gauge-label {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        /* Signal Matrix */
        .signal-matrix {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 1rem;
        }

        .signal-card {
            padding: 1rem;
            border-radius: 0.5rem;
            transition: transform 0.2s;
        }

        .signal-card:hover {
            transform: translateY(-2px);
        }

        .signal-card.tier1 {
            background: rgba(16, 185, 129, 0.15);
            border: 1px solid #10b981;
        }

        .signal-card.tier2 {
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid #3b82f6;
        }

        .signal-card.tier3 {
            background: rgba(245, 158, 11, 0.15);
            border: 1px solid #f59e0b;
        }

        .signal-card.tier4 {
            background: rgba(100, 116, 139, 0.15);
            border: 1px solid #64748b;
        }

        .signal-theme {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .signal-status {
            font-size: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .signal-status.tier1 { color: #10b981; }
        .signal-status.tier2 { color: #3b82f6; }
        .signal-status.tier3 { color: #f59e0b; }
        .signal-status.tier4 { color: #64748b; }

        .signal-confidence {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 0.25rem;
        }

        /* Funnel Chart */
        .funnel {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 0.25rem;
            padding: 0.5rem 0;
        }

        .funnel-stage {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            transition: all 0.3s;
        }

        .funnel-label { font-size: 0.75rem; white-space: nowrap; }
        .funnel-count { font-weight: bold; font-size: 1rem; margin-left: 0.5rem; }
        .funnel-arrow { color: #64748b; font-size: 1rem; line-height: 1; }

        /* Model Info */
        .model-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid #334155;
        }

        .model-stat {
            text-align: center;
        }

        .model-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #3b82f6;
        }

        .model-stat-label {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #94a3b8;
        }

        .market-flag {
            font-size: 2rem;
            margin-right: 0.5rem;
        }

        /* Header Layout */
        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
        }
        .header-content { flex: 1; }
    </style>
</head>
<body>
    <div class="header">
        <div class="container" style="padding: 0;">
            <div class="header-top">
                <div class="header-content">
                    <h1><span class="market-flag">ðŸ‡ºðŸ‡¸</span>Signal Quality Matrix</h1>
                    <p>TIER Classification and Quality Assessment (Q8, Q10, Q18)</p>
                </div>
            </div>
            <nav class="nav-links">
                <a href="index.html">Overview</a>
                <a href="breakout.html">Breakout</a>
                <a href="signals.html" class="active">Signals</a>
                <a href="cohesion.html">Cohesion</a>
                <a href="network.html">Network</a>
            </nav>
        </div>
    </div>

    <div class="container">
        <!-- Summary Cards -->
        <div class="summary-grid" id="summaryGrid">
            <div class="loading">Loading summary...</div>
        </div>

        <!-- Charts Row -->
        <div class="charts-row">
            <!-- Quality Score Gauge -->
            <div class="section">
                <h2>Quality Score</h2>
                <div class="chart-wrapper">
                    <div class="gauge-container" id="gaugeContainer">
                        <div class="gauge">
                            <div class="gauge-background"></div>
                            <div class="gauge-center"></div>
                            <div class="gauge-needle" id="gaugeNeedle"></div>
                        </div>
                        <div class="gauge-value" id="gaugeValue">--</div>
                        <div class="gauge-label">TIER 1-2 Quality Ratio</div>
                    </div>
                </div>
            </div>

            <!-- Filter Funnel -->
            <div class="section">
                <h2>Filter Funnel (Q18)</h2>
                <div class="chart-wrapper funnel-wrapper">
                    <div class="funnel" id="funnelChart">
                        <div class="loading">Loading funnel...</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Signal Matrix by Theme -->
        <div class="section">
            <h2>Signal Quality by Theme</h2>
            <p style="color: #94a3b8; margin-bottom: 1rem; font-size: 0.875rem;">
                Q8: Which themes should I focus on? | Q10: Which signals are low quality?
            </p>
            <div class="signal-matrix" id="signalMatrix">
                <div class="loading">Loading signals...</div>
            </div>
        </div>

        <!-- Model Performance -->
        <div class="section">
            <h2>Signal Classification Performance</h2>
            <div class="model-info" id="modelInfo">
                <div class="loading">Loading metrics...</div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        async function init() {
            try {
                await Promise.all([
                    loadSummary(),
                    loadFunnel(),
                    loadSignalMatrix(),
                    loadModelInfo()
                ]);
            } catch (error) {
                console.error('Error initializing:', error);
            }
        }

        async function loadSummary() {
            try {
                const response = await fetch(`${API_BASE}/api/signals/quality`);
                const data = await response.json();

                const tier1 = data.tier_distribution?.['Tier 1'] || 0;
                const tier2 = data.tier_distribution?.['Tier 2'] || 0;
                const tier3 = data.tier_distribution?.['Tier 3'] || 0;
                const tier4 = data.tier_distribution?.['Tier 4'] || 0;
                const tier12 = tier1 + tier2;
                const tier34 = tier3 + tier4;
                const qualityScore = data.quality_score || 0;

                document.getElementById('summaryGrid').innerHTML = `
                    <div class="summary-card positive">
                        <div class="summary-label">Total Signals</div>
                        <div class="summary-value">${data.total_signals || 0}</div>
                        <div class="summary-subtext">Analyzed signals</div>
                    </div>
                    <div class="summary-card positive">
                        <div class="summary-label">TIER 1-2</div>
                        <div class="summary-value positive">${tier12}</div>
                        <div class="summary-subtext">High quality signals</div>
                    </div>
                    <div class="summary-card warning">
                        <div class="summary-label">TIER 3-4</div>
                        <div class="summary-value" style="color: #f59e0b">${tier34}</div>
                        <div class="summary-subtext">Lower conviction</div>
                    </div>
                    <div class="summary-card positive">
                        <div class="summary-label">TIER 1</div>
                        <div class="summary-value">${tier1}</div>
                        <div class="summary-subtext">Highest quality</div>
                    </div>
                `;

                updateGauge(qualityScore);
            } catch (error) {
                console.error('Error loading summary:', error);
                document.getElementById('summaryGrid').innerHTML =
                    `<div class="loading">Error loading summary</div>`;
            }
        }

        function updateGauge(score) {
            const rotation = (score / 100) * 180 - 90;
            document.getElementById('gaugeNeedle').style.transform = `rotate(${rotation}deg)`;
            document.getElementById('gaugeValue').textContent = `${score.toFixed(1)}%`;

            const valueEl = document.getElementById('gaugeValue');
            if (score >= 25) {
                valueEl.style.color = '#10b981';
            } else if (score >= 15) {
                valueEl.style.color = '#f59e0b';
            } else {
                valueEl.style.color = '#ef4444';
            }
        }

        async function loadFunnel() {
            try {
                const response = await fetch(`${API_BASE}/api/signals/filter-funnel`);
                const data = await response.json();

                const colors = ['#475569', '#3b82f6', '#6366f1', '#8b5cf6', '#10b981', '#059669', '#047857'];
                const totalStages = data.funnel.length;

                document.getElementById('funnelChart').innerHTML = data.funnel.map((stage, i) => {
                    const width = 100 - (i * (60 / totalStages));
                    const color = colors[i % colors.length];
                    return `
                        ${i > 0 ? '<div class="funnel-arrow">â†“</div>' : ''}
                        <div class="funnel-stage" style="width: ${width}%; background: ${color};">
                            <span class="funnel-label">${stage.stage}</span>
                            <span class="funnel-count">${stage.count}</span>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Error loading funnel:', error);
                document.getElementById('funnelChart').innerHTML =
                    `<div class="loading">Error loading funnel</div>`;
            }
        }

        async function loadSignalMatrix() {
            try {
                const response = await fetch(`${API_BASE}/api/signals/tier-breakdown`);
                const data = await response.json();

                const matrix = document.getElementById('signalMatrix');
                let html = '';

                // Build signal cards from tier breakdown
                for (const [tier, tierData] of Object.entries(data)) {
                    const tierClass = tier.replace(' ', '').toLowerCase();
                    const tierNum = tier.replace('Tier ', '');
                    const themes = tierData.themes || [];
                    const action = tierNum === '1' ? 'AGGRESSIVE BUY' :
                                  tierNum === '2' ? 'ACCUMULATE' :
                                  tierNum === '3' ? 'RESEARCH' : 'MONITOR';

                    // Show each theme as a card
                    themes.slice(0, 8).forEach(theme => {
                        const icon = tierNum <= 2 ? 'âœ“' : tierNum === '3' ? 'â—' : 'â—‹';
                        html += `
                            <div class="signal-card ${tierClass}">
                                <div class="signal-theme">${theme}</div>
                                <div class="signal-status ${tierClass}">
                                    <span>${icon}</span> ${tier}
                                </div>
                                <div class="signal-confidence">${action} | ${tierData.unique_tickers || 0} tickers</div>
                            </div>
                        `;
                    });
                }

                matrix.innerHTML = html || '<div class="loading">No theme data available</div>';
            } catch (error) {
                console.error('Error loading signal matrix:', error);
                document.getElementById('signalMatrix').innerHTML =
                    `<div class="loading">Error loading signals</div>`;
            }
        }

        async function loadModelInfo() {
            try {
                const response = await fetch(`${API_BASE}/api/signals/quality`);
                const data = await response.json();

                const momentum = data.momentum || {};
                const cohesion = data.cohesion || {};

                document.getElementById('modelInfo').innerHTML = `
                    <div class="model-stat">
                        <div class="model-stat-value">${momentum.positive_ratio || 0}%</div>
                        <div class="model-stat-label">Positive Momentum</div>
                    </div>
                    <div class="model-stat">
                        <div class="model-stat-value">${cohesion.average_fiedler || 0}</div>
                        <div class="model-stat-label">Avg Cohesion</div>
                    </div>
                    <div class="model-stat">
                        <div class="model-stat-value">UCS-LRS</div>
                        <div class="model-stat-label">Classification System</div>
                    </div>
                    <div class="model-stat">
                        <div class="model-stat-value">${data.unique_tickers || 0}</div>
                        <div class="model-stat-label">Unique Tickers</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading model info:', error);
                document.getElementById('modelInfo').innerHTML =
                    `<div class="loading">Error loading metrics</div>`;
            }
        }

        // Initialize
        init();
    </script>
</body>
</html>
