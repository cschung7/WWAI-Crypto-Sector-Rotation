<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <title>Theme Network Graph - USA Sector Rotation</title>
    <script src="https://unpkg.com/vis-network/standalone/umd/vis-network.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            background: #0f172a;
            color: #f8fafc;
            min-height: 100vh;
        }

        .header {
            background: #1e293b;
            border-bottom: 1px solid #334155;
            padding: 1rem 2rem;
        }

        .header h1 {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 0.25rem;
        }

        .header p {
            color: #94a3b8;
            font-size: 0.875rem;
        }

        .nav-links {
            display: flex;
            gap: 1rem;
            margin-top: 0.75rem;
        }

        .nav-links a {
            color: #94a3b8;
            text-decoration: none;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            transition: all 0.2s;
            font-size: 0.875rem;
        }

        .nav-links a:hover, .nav-links a.active {
            background: #334155;
            color: #f8fafc;
        }

        .main-container {
            display: flex;
            height: calc(100vh - 120px);
        }

        .sidebar {
            width: 320px;
            background: #1e293b;
            border-right: 1px solid #334155;
            padding: 1rem;
            overflow-y: auto;
        }

        .search-box {
            margin-bottom: 1rem;
            position: relative;
        }

        .search-box label {
            display: block;
            font-size: 0.75rem;
            color: #94a3b8;
            margin-bottom: 0.25rem;
            text-transform: uppercase;
        }

        .search-input {
            display: flex;
            gap: 0.5rem;
        }

        .search-input input {
            flex: 1;
            background: #334155;
            border: 1px solid #475569;
            border-radius: 0.375rem;
            padding: 0.5rem;
            color: #f8fafc;
            font-size: 0.875rem;
        }

        .search-input input:focus {
            outline: none;
            border-color: #3b82f6;
        }

        .search-input button {
            background: #3b82f6;
            border: none;
            border-radius: 0.375rem;
            padding: 0.5rem 1rem;
            color: white;
            cursor: pointer;
            font-size: 0.875rem;
        }

        .search-input button:hover {
            background: #2563eb;
        }

        .tabs {
            display: flex;
            gap: 0.25rem;
            margin-bottom: 1rem;
        }

        .tab {
            flex: 1;
            padding: 0.5rem;
            background: #334155;
            border: none;
            border-radius: 0.375rem;
            color: #94a3b8;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .tab.active {
            background: #3b82f6;
            color: white;
        }

        .info-panel {
            background: #334155;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .info-panel h3 {
            font-size: 0.875rem;
            margin-bottom: 0.75rem;
            color: #f8fafc;
        }

        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 0.375rem 0;
            border-bottom: 1px solid #475569;
            font-size: 0.8125rem;
        }

        .info-item:last-child {
            border-bottom: none;
        }

        .info-label {
            color: #94a3b8;
        }

        .info-value {
            font-weight: 600;
        }

        .info-value.bullish { color: #10b981; }
        .info-value.neutral { color: #3b82f6; }
        .info-value.bearish { color: #ef4444; }
        .info-value.very-strong { color: #10b981; }
        .info-value.strong { color: #3b82f6; }
        .info-value.moderate { color: #f59e0b; }
        .info-value.weak { color: #ef4444; }

        .stock-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .stock-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.625rem 0.75rem;
            background: #475569;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            border-left: 3px solid transparent;
        }

        .stock-item:hover {
            background: #64748b;
        }

        .stock-item.buy, .stock-item.strong_buy {
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.15);
        }

        .stock-item.avoid {
            border-left-color: #ef4444;
            background: rgba(239, 68, 68, 0.1);
        }

        .stock-item.hold, .stock-item.neutral {
            border-left-color: #f59e0b;
            background: rgba(245, 158, 11, 0.1);
        }

        .stock-info {
            flex: 1;
        }

        .stock-name {
            font-weight: 600;
            font-size: 0.875rem;
        }

        .stock-ticker {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .stock-signal {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .signal-badge {
            padding: 0.125rem 0.5rem;
            border-radius: 0.25rem;
            font-size: 0.6875rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .signal-badge.buy, .signal-badge.strong_buy {
            background: #10b981;
            color: white;
        }

        .signal-badge.avoid {
            background: #ef4444;
            color: white;
        }

        .signal-badge.hold, .signal-badge.neutral {
            background: #f59e0b;
            color: black;
        }

        .score-text {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-top: 0.125rem;
        }

        .theme-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid #475569;
        }

        .theme-header h4 {
            font-size: 1rem;
            color: #f8fafc;
        }

        .theme-stats {
            font-size: 0.75rem;
            color: #94a3b8;
        }

        .expand-hint {
            font-size: 0.75rem;
            color: #64748b;
            text-align: center;
            padding: 0.5rem;
            font-style: italic;
        }

        .theme-list {
            max-height: 300px;
            overflow-y: auto;
        }

        .theme-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.5rem;
            background: #475569;
            border-radius: 0.375rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8125rem;
        }

        .theme-item:hover {
            background: #64748b;
        }

        .theme-item.expanded {
            background: #3b82f6;
            border-left: 3px solid #60a5fa;
        }

        .theme-name {
            flex: 1;
        }

        .theme-fiedler {
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .theme-fiedler.very_strong { background: #10b981; color: white; }
        .theme-fiedler.strong { background: #3b82f6; color: white; }
        .theme-fiedler.moderate { background: #f59e0b; color: black; }
        .theme-fiedler.weak { background: #ef4444; color: white; }

        .graph-container {
            flex: 1;
            position: relative;
        }

        #network {
            width: 100%;
            height: 100%;
            background: #0f172a;
        }

        .graph-controls {
            position: absolute;
            top: 1rem;
            right: 1rem;
            display: flex;
            gap: 0.5rem;
        }

        .control-btn {
            background: #334155;
            border: 1px solid #475569;
            border-radius: 0.375rem;
            padding: 0.5rem 0.75rem;
            color: #f8fafc;
            cursor: pointer;
            font-size: 0.75rem;
        }

        .control-btn:hover {
            background: #475569;
        }

        .control-btn.active {
            background: #3b82f6;
            border-color: #3b82f6;
        }

        .stats-bar {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            background: rgba(30, 41, 59, 0.9);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            display: flex;
            gap: 1.5rem;
            font-size: 0.75rem;
        }

        .stat {
            text-align: center;
        }

        .stat-value {
            font-size: 1.25rem;
            font-weight: bold;
            color: #3b82f6;
        }

        .stat-label {
            color: #94a3b8;
        }

        .legend {
            position: absolute;
            bottom: 1rem;
            right: 1rem;
            background: rgba(30, 41, 59, 0.9);
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            font-size: 0.75rem;
        }

        .legend-title {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 0.25rem;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 2px;
        }

        .loading-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(15, 23, 42, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .loading-text {
            color: #94a3b8;
            font-size: 1rem;
        }

        .hidden {
            display: none;
        }

        .search-suggestions {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: #1e293b;
            border: 1px solid #475569;
            border-radius: 0.375rem;
            max-height: 300px;
            overflow-y: auto;
            z-index: 1000;
            margin-top: 0.25rem;
        }

        .suggestion-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #334155;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .suggestion-item:hover, .suggestion-item.selected {
            background: #334155;
        }

        .suggestion-item:last-child {
            border-bottom: none;
        }

        .suggestion-name {
            font-size: 0.875rem;
        }

        .suggestion-type {
            font-size: 0.7rem;
            padding: 0.125rem 0.375rem;
            border-radius: 0.25rem;
            background: #475569;
        }

        .suggestion-type.stock {
            background: #3b82f6;
        }

        .suggestion-type.theme {
            background: #8b5cf6;
        }

        .suggestion-fiedler {
            font-size: 0.7rem;
            color: #94a3b8;
        }

        .suggestion-buy-pct {
            font-size: 0.7rem;
            font-weight: 600;
        }

        .suggestion-buy-pct.high { color: #10b981; }
        .suggestion-buy-pct.medium { color: #f59e0b; }
        .suggestion-buy-pct.low { color: #ef4444; }

        .market-flag {
            font-size: 1.5rem;
            margin-right: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1><span class="market-flag">üá∫üá∏</span>Theme Network Graph</h1>
            <p>Explore stock-theme relationships with Co-movement gravity</p>
        </div>
        <nav class="nav-links">
            <a href="index.html">Overview</a>
            <a href="breakout.html">Breakout</a>
            <a href="signals.html">Signals</a>
            <a href="cohesion.html">Cohesion</a>
            <a href="network.html" class="active">Network</a>
        </nav>
    </div>

    <div class="main-container">
        <div class="sidebar">
            <!-- Search -->
            <div class="search-box">
                <label>Search Stock or Theme <span style="color: #64748b;">(partial match)</span></label>
                <div class="tabs">
                    <button class="tab active" onclick="setSearchMode('stock')">Stock</button>
                    <button class="tab" onclick="setSearchMode('theme')">Theme</button>
                </div>
                <div class="search-input" style="position: relative;">
                    <input type="text" id="searchInput" placeholder="e.g., TSLA, Space, Battery"
                           oninput="onSearchInput()" onkeydown="onSearchKeydown(event)">
                    <button onclick="doSearch()">Search</button>
                </div>
                <div id="searchSuggestions" class="search-suggestions hidden"></div>
                <div id="searchHint" style="font-size: 0.7rem; color: #64748b; margin-top: 0.25rem;">
                    Type 2+ chars for suggestions (30 themes)
                </div>
            </div>

            <!-- Selected Node Info -->
            <div class="info-panel" id="nodeInfo">
                <h3>Selected Node</h3>
                <div id="nodeDetails">
                    <p style="color: #64748b; font-size: 0.8125rem;">Click a node to see details</p>
                </div>
            </div>

            <!-- Connected Themes/Stocks -->
            <div class="info-panel">
                <h3 id="connectionTitle">Connected Themes</h3>
                <div class="theme-list" id="connectionList">
                    <p style="color: #64748b; font-size: 0.8125rem;">Search for a stock to see themes</p>
                </div>
            </div>
        </div>

        <div class="graph-container">
            <div id="network"></div>

            <div class="loading-overlay hidden" id="loadingOverlay">
                <div class="loading-text">Loading graph...</div>
            </div>

            <div class="graph-controls">
                <button class="control-btn active" id="physicsBtn" onclick="togglePhysics()">Physics: ON</button>
                <button class="control-btn" onclick="fitGraph()">Fit View</button>
                <button class="control-btn" onclick="resetGraph()">Reset</button>
            </div>

            <div class="stats-bar">
                <div class="stat">
                    <div class="stat-value" id="statStocks">0</div>
                    <div class="stat-label">Stocks</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="statThemes">0</div>
                    <div class="stat-label">Themes</div>
                </div>
                <div class="stat">
                    <div class="stat-value" id="statEdges">0</div>
                    <div class="stat-label">Connections</div>
                </div>
            </div>

            <div class="legend">
                <div class="legend-title">Co-movement Gravity</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #10b981"></div>
                    <span>Very Strong (>3.0)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #3b82f6"></div>
                    <span>Strong (1-3)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f59e0b"></div>
                    <span>Moderate (0.5-1)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef4444"></div>
                    <span>Weak (<0.5)</span>
                </div>
                <div class="legend-title" style="margin-top: 0.75rem;">Stock Signal (Score%)</div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #059669; border-radius: 50%;"></div>
                    <span>Strong Buy (‚â•70%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #10b981; border-radius: 50%;"></div>
                    <span>Buy (50-70%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #f59e0b; border-radius: 50%;"></div>
                    <span>Neutral (30-50%)</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background: #ef4444; border-radius: 50%;"></div>
                    <span>Avoid (<30%)</span>
                </div>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = window.location.origin;
        let network = null;
        let nodes = new vis.DataSet();
        let edges = new vis.DataSet();
        let searchMode = 'stock';
        let physicsEnabled = true;
        let expandedThemes = new Set();
        let currentStockThemes = null;

        // Network options
        const options = {
            nodes: {
                font: {
                    color: '#ffffff',
                    size: 12,
                    face: 'system-ui'
                },
                borderWidth: 2,
                shadow: true
            },
            edges: {
                color: {
                    color: '#8b5cf6',
                    opacity: 0.6
                },
                width: 2,
                smooth: {
                    type: 'continuous'
                }
            },
            physics: {
                enabled: true,
                solver: 'forceAtlas2Based',
                forceAtlas2Based: {
                    gravitationalConstant: -100,
                    centralGravity: 0.01,
                    springLength: 150,
                    springConstant: 0.05,
                    avoidOverlap: 0.5
                },
                stabilization: {
                    iterations: 100,
                    updateInterval: 25
                }
            },
            interaction: {
                hover: true,
                tooltipDelay: 200
            }
        };

        function initNetwork() {
            const container = document.getElementById('network');
            network = new vis.Network(container, { nodes, edges }, options);

            network.on('click', onNodeClick);
            network.on('doubleClick', onNodeDoubleClick);
            network.on('stabilized', () => {
                document.getElementById('loadingOverlay').classList.add('hidden');
            });

            loadDefaultGraph();
        }

        async function loadDefaultGraph() {
            showLoading();
            try {
                const response = await fetch(`${API_BASE}/api/network/graph-data`);
                const data = await response.json();
                renderGraph(data);
            } catch (error) {
                console.error('Error loading graph:', error);
                hideLoading();
            }
        }

        function getStockColor(signal, buyPct) {
            const pct = buyPct || 0;
            if (signal === 'strong_buy' || pct >= 70) {
                return { bg: '#059669', border: '#047857' };
            } else if (signal === 'buy' || pct >= 50) {
                return { bg: '#10b981', border: '#059669' };
            } else if (signal === 'neutral' || pct >= 30) {
                return { bg: '#f59e0b', border: '#d97706' };
            } else {
                return { bg: '#ef4444', border: '#dc2626' };
            }
        }

        function getSignalLabel(signal, buyPct) {
            const pct = buyPct || 0;
            if (signal === 'strong_buy' || pct >= 70) return 'strong_buy';
            if (signal === 'buy' || pct >= 50) return 'buy';
            if (signal === 'neutral' || pct >= 30) return 'hold';
            return 'avoid';
        }

        function getSignalText(signal, buyPct) {
            const pct = buyPct || 0;
            if (signal === 'strong_buy' || pct >= 70) return `BUY ${pct.toFixed(0)}%`;
            if (signal === 'buy' || pct >= 50) return `BUY ${pct.toFixed(0)}%`;
            if (signal === 'neutral' || pct >= 30) return `HOLD ${pct.toFixed(0)}%`;
            return `AVOID ${pct.toFixed(0)}%`;
        }

        function renderGraph(data) {
            nodes.clear();
            edges.clear();
            expandedThemes.clear();

            data.nodes.forEach(node => {
                let visNode;

                if (node.type === 'stock') {
                    const colors = getStockColor(node.signal, node.score);
                    visNode = {
                        id: node.id,
                        label: node.label,
                        title: getNodeTooltip(node),
                        shape: 'dot',
                        color: {
                            background: colors.bg,
                            border: colors.border,
                            highlight: {
                                background: adjustColor(colors.bg, 20),
                                border: colors.bg
                            }
                        },
                        font: {
                            size: node.isCenter ? 14 : 11,
                            color: '#ffffff'
                        },
                        size: node.isCenter ? 35 : 22,
                        nodeData: node
                    };
                } else {
                    visNode = {
                        id: node.id,
                        label: node.label,
                        title: getNodeTooltip(node),
                        shape: 'box',
                        color: {
                            background: node.color,
                            border: adjustColor(node.color, -20),
                            highlight: {
                                background: adjustColor(node.color, 20),
                                border: node.color
                            }
                        },
                        font: {
                            size: 12,
                            color: '#ffffff',
                            bold: true
                        },
                        size: node.size || 25,
                        nodeData: node
                    };
                }
                nodes.add(visNode);
            });

            data.edges.forEach(edge => {
                edges.add({
                    id: edge.id,
                    from: edge.from,
                    to: edge.to
                });
            });

            updateStats(data.stats);
            hideLoading();

            setTimeout(() => network.fit(), 500);
        }

        function getNodeTooltip(node) {
            if (node.type === 'stock') {
                return `${node.label}\nTicker: ${node.ticker}\nSignal: ${node.signal}\nScore: ${node.score}`;
            } else {
                return `${node.label}\nCohesion: ${node.fiedler}`;
            }
        }

        function adjustColor(hex, amount) {
            const num = parseInt(hex.replace('#', ''), 16);
            const r = Math.min(255, Math.max(0, (num >> 16) + amount));
            const g = Math.min(255, Math.max(0, ((num >> 8) & 0x00FF) + amount));
            const b = Math.min(255, Math.max(0, (num & 0x0000FF) + amount));
            return `#${(1 << 24 | r << 16 | g << 8 | b).toString(16).slice(1)}`;
        }

        let searchTimeout = null;
        let selectedSuggestionIndex = -1;
        let currentSuggestions = [];

        function setSearchMode(mode) {
            searchMode = mode;
            document.querySelectorAll('.tabs .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            document.getElementById('searchInput').placeholder =
                mode === 'stock' ? 'e.g., TSLA, GE, NVDA' : 'e.g., Space, Battery, AI';
            hideSuggestions();
        }

        function onSearchInput() {
            const query = document.getElementById('searchInput').value.trim();
            if (query.length < 2) {
                hideSuggestions();
                return;
            }

            if (searchTimeout) clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => fetchSuggestions(query), 200);
        }

        async function fetchSuggestions(query) {
            try {
                const response = await fetch(`${API_BASE}/api/network/search?q=${encodeURIComponent(query)}&limit=15`);
                const data = await response.json();

                if (!data.success) {
                    hideSuggestions();
                    return;
                }

                currentSuggestions = [];
                const container = document.getElementById('searchSuggestions');

                let html = '';

                if (searchMode === 'stock') {
                    data.stocks.forEach(stock => {
                        currentSuggestions.push({ type: 'stock', name: stock.name, data: stock });
                        const buyClass = stock.buy_pct >= 50 ? 'high' : stock.buy_pct >= 30 ? 'medium' : 'low';
                        html += `
                            <div class="suggestion-item" onclick="selectSuggestion('stock', '${stock.name.replace(/'/g, "\\'")}')">
                                <span class="suggestion-name">${stock.name}</span>
                                <span class="suggestion-type stock">Stock</span>
                                <span class="suggestion-buy-pct ${buyClass}">${stock.buy_pct.toFixed(0)}%</span>
                            </div>
                        `;
                    });
                    data.themes.forEach(theme => {
                        currentSuggestions.push({ type: 'theme', name: theme.theme, data: theme });
                        html += `
                            <div class="suggestion-item" onclick="selectSuggestion('theme', '${theme.theme.replace(/'/g, "\\'")}')">
                                <span class="suggestion-name">${theme.theme}</span>
                                <span class="suggestion-type theme">Theme</span>
                                <span class="suggestion-fiedler">${theme.fiedler.toFixed(2)}</span>
                            </div>
                        `;
                    });
                } else {
                    data.themes.forEach(theme => {
                        currentSuggestions.push({ type: 'theme', name: theme.theme, data: theme });
                        html += `
                            <div class="suggestion-item" onclick="selectSuggestion('theme', '${theme.theme.replace(/'/g, "\\'")}')">
                                <span class="suggestion-name">${theme.theme}</span>
                                <span class="suggestion-type theme">Theme</span>
                                <span class="suggestion-fiedler">${theme.fiedler.toFixed(2)}</span>
                            </div>
                        `;
                    });
                    data.stocks.forEach(stock => {
                        currentSuggestions.push({ type: 'stock', name: stock.name, data: stock });
                        const buyClass = stock.buy_pct >= 50 ? 'high' : stock.buy_pct >= 30 ? 'medium' : 'low';
                        html += `
                            <div class="suggestion-item" onclick="selectSuggestion('stock', '${stock.name.replace(/'/g, "\\'")}')">
                                <span class="suggestion-name">${stock.name}</span>
                                <span class="suggestion-type stock">Stock</span>
                                <span class="suggestion-buy-pct ${buyClass}">${stock.buy_pct.toFixed(0)}%</span>
                            </div>
                        `;
                    });
                }

                if (html) {
                    container.innerHTML = html;
                    container.classList.remove('hidden');
                    selectedSuggestionIndex = -1;
                } else {
                    hideSuggestions();
                }
            } catch (error) {
                console.error('Error fetching suggestions:', error);
                hideSuggestions();
            }
        }

        function onSearchKeydown(event) {
            const container = document.getElementById('searchSuggestions');
            const items = container.querySelectorAll('.suggestion-item');

            if (event.key === 'ArrowDown') {
                event.preventDefault();
                selectedSuggestionIndex = Math.min(selectedSuggestionIndex + 1, items.length - 1);
                updateSelectedSuggestion(items);
            } else if (event.key === 'ArrowUp') {
                event.preventDefault();
                selectedSuggestionIndex = Math.max(selectedSuggestionIndex - 1, -1);
                updateSelectedSuggestion(items);
            } else if (event.key === 'Enter') {
                if (selectedSuggestionIndex >= 0 && currentSuggestions[selectedSuggestionIndex]) {
                    const suggestion = currentSuggestions[selectedSuggestionIndex];
                    selectSuggestion(suggestion.type, suggestion.name);
                } else {
                    doSearch();
                }
            } else if (event.key === 'Escape') {
                hideSuggestions();
            }
        }

        function updateSelectedSuggestion(items) {
            items.forEach((item, i) => {
                item.classList.toggle('selected', i === selectedSuggestionIndex);
            });
            if (selectedSuggestionIndex >= 0 && items[selectedSuggestionIndex]) {
                items[selectedSuggestionIndex].scrollIntoView({ block: 'nearest' });
            }
        }

        function selectSuggestion(type, name) {
            document.getElementById('searchInput').value = name;
            searchMode = type;
            document.querySelectorAll('.tabs .tab').forEach((t, i) => {
                t.classList.toggle('active', (type === 'stock' && i === 0) || (type === 'theme' && i === 1));
            });
            hideSuggestions();
            doSearch();
        }

        function hideSuggestions() {
            document.getElementById('searchSuggestions').classList.add('hidden');
            selectedSuggestionIndex = -1;
            currentSuggestions = [];
        }

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.search-box')) {
                hideSuggestions();
            }
        });

        async function doSearch() {
            const query = document.getElementById('searchInput').value.trim();
            if (!query) return;

            showLoading();
            try {
                const param = searchMode === 'stock' ? `stock=${encodeURIComponent(query)}` : `theme=${encodeURIComponent(query)}`;
                const response = await fetch(`${API_BASE}/api/network/graph-data?${param}&depth=1`);
                const data = await response.json();

                if (!data.success) {
                    alert(data.detail || 'Not found');
                    hideLoading();
                    return;
                }

                renderGraph(data);
                loadConnectionList(query, searchMode);
            } catch (error) {
                console.error('Error:', error);
                alert('Search failed: ' + error.message);
                hideLoading();
            }
        }

        async function loadConnectionList(name, type) {
            try {
                let endpoint, titleText;
                if (type === 'stock') {
                    endpoint = `/api/network/stock-themes?name=${encodeURIComponent(name)}`;
                    titleText = 'Connected Themes';
                } else {
                    endpoint = `/api/network/theme-stocks?theme=${encodeURIComponent(name)}&limit=20`;
                    titleText = 'Stocks in Theme';
                }

                const response = await fetch(`${API_BASE}${endpoint}`);
                const data = await response.json();

                document.getElementById('connectionTitle').textContent = titleText;
                const list = document.getElementById('connectionList');

                if (type === 'stock' && data.themes) {
                    currentStockThemes = data.themes;
                    refreshThemeList();
                } else if (type === 'theme' && data.stocks) {
                    list.innerHTML = data.stocks.map(s => `
                        <div class="theme-item" onclick="loadStock('${s.ticker}')">
                            <span class="theme-name">${s.name}</span>
                            <span class="theme-fiedler ${s.signal}">${s.total_score.toFixed(2)}</span>
                        </div>
                    `).join('');
                }
            } catch (error) {
                console.error('Error loading connections:', error);
            }
        }

        async function expandTheme(themeName) {
            if (expandedThemes.has(themeName)) {
                collapseTheme(themeName);
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/api/network/theme-stocks?theme=${encodeURIComponent(themeName)}&limit=15`);
                const data = await response.json();

                if (!data.success) return;

                updateStockList(themeName, data);

                data.stocks.forEach(stock => {
                    const nodeId = `stock_${stock.ticker}`;
                    if (!nodes.get(nodeId)) {
                        const buyPct = stock.buy_pct || 0;
                        const colors = getStockColor(stock.signal, buyPct);
                        const signalLabel = getSignalLabel(stock.signal, buyPct);
                        const signalText = getSignalText(stock.signal, buyPct);

                        nodes.add({
                            id: nodeId,
                            label: stock.ticker,
                            title: `${stock.name}\nTicker: ${stock.ticker}\nBuy: ${buyPct.toFixed(1)}%\nSignal: ${signalText}`,
                            shape: 'dot',
                            color: {
                                background: colors.bg,
                                border: colors.border,
                                highlight: {
                                    background: adjustColor(colors.bg, 20),
                                    border: colors.bg
                                }
                            },
                            size: 20,
                            nodeData: { type: 'stock', ...stock, signalLabel, buyPct }
                        });

                        edges.add({
                            id: `edge_${themeName}_${stock.ticker}`,
                            from: `theme_${themeName}`,
                            to: nodeId
                        });
                    }
                });

                expandedThemes.add(themeName);
                updateStats();

                if (currentStockThemes) {
                    refreshThemeList();
                }
            } catch (error) {
                console.error('Error expanding theme:', error);
            }
        }

        function refreshThemeList() {
            if (!currentStockThemes) return;
            const list = document.getElementById('connectionList');
            list.innerHTML = currentStockThemes.map(t => {
                const isExpanded = expandedThemes.has(t.theme);
                return `
                    <div class="theme-item ${isExpanded ? 'expanded' : ''}" onclick="expandTheme('${t.theme.replace(/'/g, "\\'")}')">
                        <span class="theme-name">${isExpanded ? '‚ñº' : '‚ñ∂'} ${t.theme}</span>
                        <span class="theme-fiedler ${t.cohesion_level}">${t.fiedler.toFixed(2)}</span>
                    </div>
                `;
            }).join('');
        }

        function updateStockList(themeName, data) {
            document.getElementById('connectionTitle').textContent = `${themeName} Stocks`;
            const list = document.getElementById('connectionList');

            const buyCount = data.stocks.filter(s => (s.buy_pct || 0) >= 50).length;
            const avoidCount = data.stocks.filter(s => (s.buy_pct || 0) < 30).length;

            let html = `
                <div class="theme-header">
                    <h4>Cohesion: ${data.fiedler.toFixed(2)}</h4>
                    <div class="theme-stats">
                        <span style="color: #10b981;">${buyCount} Buy</span> /
                        <span style="color: #ef4444;">${avoidCount} Avoid</span>
                    </div>
                </div>
                <div class="stock-list">
            `;

            data.stocks.forEach(stock => {
                const buyPct = stock.buy_pct || 0;
                const signalLabel = getSignalLabel(stock.signal, buyPct);
                const signalText = getSignalText(stock.signal, buyPct);
                html += `
                    <div class="stock-item ${signalLabel}">
                        <div class="stock-info" onclick="loadStock('${stock.ticker}')" style="cursor: pointer;">
                            <div class="stock-name">${stock.name}</div>
                            <div class="stock-ticker">${stock.ticker} ¬∑ ${stock.market}</div>
                        </div>
                        <div class="stock-signal">
                            <span class="signal-badge ${signalLabel}">${signalText}</span>
                        </div>
                    </div>
                `;
            });

            html += `</div>
                <div class="expand-hint">Click stock to see its themes</div>
            `;

            list.innerHTML = html;
        }

        function collapseTheme(themeName) {
            const edgesToRemove = edges.get().filter(e =>
                e.from === `theme_${themeName}` && e.to.startsWith('stock_')
            );

            edgesToRemove.forEach(edge => {
                const nodeId = edge.to;
                const otherEdges = edges.get().filter(e =>
                    (e.to === nodeId || e.from === nodeId) && e.id !== edge.id
                );

                if (otherEdges.length === 0) {
                    nodes.remove(nodeId);
                }
                edges.remove(edge.id);
            });

            expandedThemes.delete(themeName);
            updateStats();

            if (currentStockThemes) {
                document.getElementById('connectionTitle').textContent = 'Connected Themes';
                refreshThemeList();
            }
        }

        function loadStock(stockTicker) {
            document.getElementById('searchInput').value = stockTicker;
            searchMode = 'stock';
            document.querySelectorAll('.tabs .tab').forEach((t, i) => {
                t.classList.toggle('active', i === 0);
            });
            doSearch();
        }

        function onNodeClick(params) {
            if (params.nodes.length === 0) return;

            const nodeId = params.nodes[0];
            const node = nodes.get(nodeId);
            if (!node || !node.nodeData) return;

            const data = node.nodeData;
            const details = document.getElementById('nodeDetails');

            if (data.type === 'stock') {
                const buyPct = data.buyPct || data.buy_pct || data.score || 0;
                const signalLabel = data.signalLabel || getSignalLabel(data.signal, buyPct);
                const signalText = getSignalText(data.signal, buyPct);
                const stockName = data.label || data.name || data.ticker;
                const buyClass = buyPct >= 50 ? 'color: #10b981' : buyPct >= 30 ? 'color: #f59e0b' : 'color: #ef4444';
                details.innerHTML = `
                    <div class="info-item">
                        <span class="info-label">Name</span>
                        <span class="info-value">${stockName}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Ticker</span>
                        <span class="info-value">${data.ticker || '-'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Signal</span>
                        <span class="info-value" style="${buyClass}; font-weight: bold;">${signalText}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Signal %</span>
                        <span class="info-value" style="font-size: 0.75rem;">
                            ‚ñ≤${(data.signal_probability?.buy || buyPct).toFixed(1)}%
                            ‚óè${(data.signal_probability?.neutral || 0).toFixed(1)}%
                            ‚ñº${(data.signal_probability?.sell || 0).toFixed(1)}%
                        </span>
                    </div>
                `;
            } else {
                const level = data.fiedler > 3 ? 'very-strong' :
                              data.fiedler >= 1 ? 'strong' :
                              data.fiedler >= 0.5 ? 'moderate' : 'weak';
                const isExpanded = expandedThemes.has(data.label);
                details.innerHTML = `
                    <div class="info-item">
                        <span class="info-label">Theme</span>
                        <span class="info-value">${data.label}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Co-movement</span>
                        <span class="info-value ${level}">${data.fiedler?.toFixed(3) || '-'}</span>
                    </div>
                    <div class="info-item">
                        <span class="info-label">Status</span>
                        <span class="info-value">${isExpanded ? 'Expanded (click to collapse)' : 'Click to expand'}</span>
                    </div>
                `;

                expandTheme(data.label);
            }
        }

        function onNodeDoubleClick(params) {
            if (params.nodes.length === 0) return;

            const nodeId = params.nodes[0];
            const node = nodes.get(nodeId);
            if (!node || !node.nodeData) return;

            const data = node.nodeData;

            if (data.type === 'theme') {
                expandTheme(data.label);
            } else if (data.type === 'stock') {
                loadStock(data.ticker || data.label);
            }
        }

        function togglePhysics() {
            physicsEnabled = !physicsEnabled;
            network.setOptions({ physics: { enabled: physicsEnabled } });
            const btn = document.getElementById('physicsBtn');
            btn.textContent = physicsEnabled ? 'Physics: ON' : 'Physics: OFF';
            btn.classList.toggle('active', physicsEnabled);
        }

        function fitGraph() {
            network.fit({ animation: true });
        }

        function resetGraph() {
            loadDefaultGraph();
        }

        function updateStats(stats) {
            if (stats) {
                document.getElementById('statStocks').textContent = stats.stock_count;
                document.getElementById('statThemes').textContent = stats.theme_count;
                document.getElementById('statEdges').textContent = stats.edge_count;
            } else {
                document.getElementById('statStocks').textContent = nodes.get().filter(n => n.nodeData?.type === 'stock').length;
                document.getElementById('statThemes').textContent = nodes.get().filter(n => n.nodeData?.type === 'theme').length;
                document.getElementById('statEdges').textContent = edges.length;
            }
        }

        function showLoading() {
            document.getElementById('loadingOverlay').classList.remove('hidden');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        document.getElementById('searchInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') doSearch();
        });

        initNetwork();

        const urlParams = new URLSearchParams(window.location.search);
        const stockParam = urlParams.get('stock');
        const themeParam = urlParams.get('theme');

        if (stockParam) {
            document.getElementById('searchInput').value = stockParam;
            searchMode = 'stock';
            setTimeout(doSearch, 500);
        } else if (themeParam) {
            document.getElementById('searchInput').value = themeParam;
            searchMode = 'theme';
            setTimeout(doSearch, 500);
        }
    </script>
</body>
</html>
